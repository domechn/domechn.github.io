


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>  Drone 在 K8S 中执行一次构建都经历了什么 |    Domechn.</title>
  <meta name="description" content="A minimalist theme for hexo.">
  <!-- 标签页图标 -->
  
  <link rel="shortcut icon" href="/favicon.png" type="image/x-icon">
  

  <!-- 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
  <!-- 动画库 -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fushaolei/cdn-white@1.0/css/animate.css"/>
  
  <!-- css文件 -->
  
<link rel="stylesheet" href="/css/white.css">

  <!-- 代码高亮 -->
  
    
      
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.1/styles/github.css">

    
  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Not Bad" type="application/atom+xml">
</head>


<body>

<div class="menu-outer">
    <div class="menu-inner">
      <div class="menu-site-name  animate__animated  animate__fadeInUp">
        <a href="/">
          Domechn.
        </a>
        
      </div>
      <div class="menu-group">
        <ul class="menu-ul">
        
          <a href="/" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              HOME
            </li>
          </a>
        
          <a href="/archives" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              BLOG
            </li>
          </a>
        
          <a href="/mypages/footprints" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              FOOTPRINTS
            </li>
          </a>
        
          <a href="/atom.xml" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              RSS
            </li>
          </a>
        
        
        
        <a href="/search">
          <li class="menu-li  animate__animated  animate__fadeInUp">
            <i class="ri-search-line"></i>
          </li>
        </a>
        
          <li class="menu-li animate__animated  animate__fadeInUp" id="mobile-menu">
            <i class="ri-menu-line"></i>
          </li>
        
        </ul>

      </div>

    </div>
</div>
<div id="mobile-main" class="animate__animated  animate__fadeIn">
  <div class="mobile-menu-inner">
    <div class="mobile-menu-site-name animate__animated  animate__fadeInUp">
      <a href="/">
        Domechn.
      </a>
    </div>
    <div class="mobile-menu-group" id="mobile-close">
      <i class="ri-close-line"></i>
    </div>

  </div>

  <div class="mobile-menu-div">
  
    <a href="/" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>HOME</span>
      </div>
    </a>
  
    <a href="/archives" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>BLOG</span>
      </div>
    </a>
  
    <a href="/mypages/footprints" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>FOOTPRINTS</span>
      </div>
    </a>
  
    <a href="/atom.xml" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>RSS</span>
      </div>
    </a>
  
  
    <a href="/search">  
      <div class="mobile-menu-child  animate__animated  animate__fadeInUp">
        <i class="ri-search-line"></i>
      </div>
    </a>
    
  </div>


</div>

<div class="body-outer">
  <div class="body-inner">
    
<article class="post-inner">
  <div class="post-content-outer">
    <div class="post-intro">
      <div class="post-title animate__animated  animate__fadeInUp">Drone 在 K8S 中执行一次构建都经历了什么</div>
      <div class="meta-intro animate__animated  animate__fadeInUp">Oct 22 2019</div>
      
    </div>
    <div class="post-content-inner">
      <div class="post-content-inner-space">

      </div>
      <div class="post-content-main animate__animated  animate__fadeInUp">
        <!-- top型目录 -->
        
        <p>在谈这个问题之前我们先来看看 drone 的结构。</p>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>drone 由 3 个主要的部分组成，分别是 <code>drone-server</code>、<code>drone-controller</code> 和 <code>drone-agent</code>。</p>
<h3 id="drone-server"><a href="#drone-server" class="headerlink" title="drone-server"></a>drone-server</h3><p>顾名思义，<code>drone-server</code> 是 drone 的服务端，它会启动一个 <code>http</code> 服务来处理各种请求，如 github 每次 push 或者其他操作触发的 webhook 亦或者是 <code>drone-web-ui</code> 的每个请求。</p>
<h3 id="drone-controller"><a href="#drone-controller" class="headerlink" title="drone-controller"></a>drone-controller</h3><p>controller 的作用是初始化 pipeline 信息，它会定义好 pipeline 的每个 step 在执行之前、执行之后以及获取和写入执行日志的函数，并保证每个 pipeline 能按顺序执行 step。</p>
<h3 id="drone-agent"><a href="#drone-agent" class="headerlink" title="drone-agent"></a>drone-agent</h3><p>可以将 <code>drone-agent</code> 在 <code>drone</code> 中的作用简单的理解为是 <code>kubelet</code> 在 <code>k8s</code> 中的作用，因为本文主要讨论的是 drone 在 k8s 中的执行过程，在 k8s 中，drone 的执行并不依赖 <code>drone-agent</code>，所以本文并不会对该组件做详细介绍。</p>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><ul>
<li>当在 github 上完成一次提交后，github 会将本次提交的信息发送到 <code>/hook</code>，<code>drone-server</code> 收到了请求之后，会将这些信息解析成 <code>core.Hook</code> 和 <code>core.Repository</code>。</li>
<li>接着会根据仓库的 <code>namespace</code> 和 <code>name</code> 在 drone 的数据库中查找该仓库，如果找不到或者项目不是 active 状态，则直接结束构建并返回错误信息。否则会将接下来的任务交给 <code>trigger</code> 来完成。</li>
</ul>
<h3 id="trigger"><a href="#trigger" class="headerlink" title="trigger"></a>trigger</h3><ol>
<li><code>trigger</code> 接收到 <code>core.Hook</code> 和 <code>core.Repository</code> 后会检查 commit message 中是否存在 <code>[ci skip]</code> 等跳过执行 ci 的字段，如果存在则直接结束。</li>
<li>接着 <code>trigger</code> 会验证 <code>repo</code> 和 <code>owner</code> 是否合法，commit message 是否为空，如果为空 <code>trigger</code> 会调用相关 api 获取上次提交的 commit message。</li>
<li>接下来 <code>trigger</code> 会向 <code>ConfigService</code> 请求构建的配置，一般情况下也就是 <code>.drone.yml</code> 中的内容。<code>ConfigService</code> 可以通过 <code>DRONE_YAML_ENDPOINT</code> 这一环境变量变量扩展，如果不扩展会使用默认的 <code>FileService</code> 也就是调用 github 的相关接口来获取 file data。</li>
<li>获取到 config 后 trigger 会调用 <code>ConvertService</code> 来转换 config，将 config 转换成 <code>yaml</code> (因为配置文件并非都是 <code>yaml</code>，可能是 <code>jsonnet</code> 或者 <code>script</code> 等其他格式)。<code>ConvertService</code> 目前支持 <code>jsonnet</code> 和 <code>starlark</code>。其中 starlark 需要使用外部扩展，也就是 <code>DRONE_CONVERT_PLUGIN_ENDPOINT</code> 来配置。</li>
<li>Convert 之后，trigger 会再解析一次 yaml，这里一来是可以将旧版本的 drone 的 yaml 格式转换为新的格式，二来是 drone 兼容 <code>gitlab-ci</code>，这一步可以将 gitlab-ci 的配置格式转换为 drone 的配置格式。</li>
<li>接下来 trigger 将 yaml 解析成 <code>yaml.Manifest</code> 结构体。之后会调用 <code>ValidateService</code> 来验证 <code>config</code>、<code>core.Build</code>、<code>repo owner</code> 和 <code>repo</code>，<code>ValidateService</code> 由 <code>DRONE_VALIDATE_PLUGIN_ENDPOINT</code> 环境变量配置，如果没有则不会这一步验证。</li>
<li>接下来 <code>trigger</code> 会验证 <code>yaml.Manifest</code> 中每个 <code>pipeline</code> 是否合法。会检查是否有 <code>重名 pipeline</code>，是否 step 中有 <code>自我依赖</code> 是否有 <code>依赖不存在</code> 以及 <code>权限</code> 等信息。</li>
<li>每个 pipeline 自身都通过验证后，<code>trigger</code> 会使用 <code>directed acyclic graph</code> 也就是有向无环图来检查各个 pipeline 之间是否有 <code>循环依赖</code>，并检查有哪些 piepline 不满足执行条件。</li>
<li>并同时检查每个 pipeline 是否满足执行条件。包括<code>branch</code>、<code>event</code>、<code>action</code>、<code>ref</code>等是否满足。</li>
<li>当上述验证条件都通过后，<code>trigger</code> 会更新数据库中的信息。然后将每个 pipeline 构建成 <code>core.Stage</code>，stage 没有依赖，那么它的 <code>status</code> 就会被设置为 <code>Pending</code>，这意味着它可以被执行了，如果有依赖，那么 <code>status</code> 就会被设置成 <code>Waiting</code>。</li>
<li><code>trigger</code> 会在数据库中创建好 <code>build</code> 信息，会向 github 发送构建状态，此时在 github 中我们就能看到那个小黄点了。</li>
<li>接着 <code>trigger</code> 会遍历每个 <code>stage</code>，并将 status 是 <code>Pending</code> 的 stage 进行调度。</li>
<li>然后将构建信息发送到环境变量 <code>DRONE_WEBHOOK_ENDPOINT</code> 配置的地址。至此 <code>trigger</code> 的工作就结束了。</li>
</ol>
<p>
        <span class="lazyload-img-span">
        <img   
           data-src="/images/drone_k8s/server.png" >
        </sapn>
      </p>
<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p>因为 <code>k8s</code> 带来的便利性，调度 <code>stage</code> 仅仅需要创建一个 <code>job</code>，在创建 job 之前， <code>scheduler</code> 会将 <code>drone-server</code> 中的大部分环境变量注入到该 job 也就是 <code>drone-job-stage.ID-randomString</code>(因为 k8s 对于每个资源的名称都有规范(不能以 <code>. _ -</code> 开头或结尾)，而在 <code>drone</code> 的其他 runtime 中并没有这一要求，所以为了符合 k8s 的命名规范，<code>drone</code> 使用了随机字符来作为资源名称。在创建 job 时，处于某些原因(后面会提到)，drone 还会该 job 挂载一个 <code>HostPath</code> 的 <code>volume</code>，路径为 <code>/tmp/drone</code>。该 <code>job</code> 的 <code>image name</code> 就是 <code>drone-controller</code>。</p>
<ol>
<li><code>drone-controller</code> 会初始化外部的 <code>SecretService</code>，该 service 有 <code>DRONE_SECRET_ENDPOINT</code> 配置。</li>
<li>接下来 <code>drone-controller</code> 会初始化三个 <code>registryService</code>，分别是 两个外部定义（由 <code>DRONE_SECRET_ENDPOINT</code> 和 <code>DRONE_REGISTRY_ENDPOINT</code> 配置) 和 本地文件（路径由 <code>DRONE_DOCKER_CONFIG</code> 定义）。</li>
<li><code>drone-controller</code> 还会初始化 <code>rpc client</code> 用于和 <code>drone-server</code> 通信。</li>
<li>最后 controller 会初始化好 <code>k8s engine</code>，至此 controller 的初始化工作就完成了，接下来的工作会交给 <code>runner</code> 这个内部组件来执行。</li>
</ol>
<h3 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h3><ol>
<li><code>runner</code> 会首先根据 <code>stage</code> 的 id 向 <code>drone-server</code> 获取 stage 的详细信息。</li>
<li>然后根据获取到的 repo.ID 获取 clone repo 所需要的 <code>token</code>。<code>drone-server</code> 接收到该请求后会先验证 repo 和 user，通过后会向 github 获取 token，用于拉取项目。</li>
<li>然后 runner 会检查构建的状态，如果不是 <code>killed</code> 或者 <code>skipped</code> 就会执行构建。</li>
<li>验证完成后 <code>runner</code> 会再次解析一次 <code>yaml</code> 的格式，这一步和 trigger 中执行的步骤一样。</li>
<li>之后 runner 会将 yaml 中所有 <code>$&#123;&#125;</code> 内的数据替换成对应的环境变量。</li>
<li>然后 runner 会根据 stage name 来从 yaml 中获取自己需要执行的 pipeline 的详细信息（因为 yaml 中往往包含多个 pipeline），之后再对自身的 pipeline 信息进行一次 lint，这次 lint 和 <code>trigger</code> 中第 <code>7</code> 步的操作是一样的，旨在保证元数据的合法性。</li>
<li>接着 runner 开始设置一系列的 <code>transform function</code>，包括 <code>registry</code>、<code>secret</code>、<code>volume</code> 等函数，这些函数会在之后的 <code>Compile</code> 中为 <code>Spec</code> 注入对应的资源，比如 <code>secret function</code> 会获取相应的 secret 并添加到 <code>spec</code> 中。</li>
<li>当上述操作都完成后，runner 便调用 <code>compiler</code> 模块开始编译 <code>pipeline</code>。</li>
</ol>
<h3 id="compiler"><a href="#compiler" class="headerlink" title="compiler"></a>compiler</h3><ol>
<li>在 <code>Compile</code> 开始时，compiler 会先确认 pipeline 的所有 steps 是否是 <code>serial</code> 的（如果 step 中存在依赖，则不是 serial）。然后会为 pipeline 挂载工作目录，也就是向 <code>spec</code> 中注入 <code>volume</code>，该 volume 为 <code>EmptyDir</code>。</li>
<li>接着把 yaml 中所有定义的 volumes 注入到 spec 之中。</li>
<li>compiler 会检查 piepline 是否需要 clone repo，如果 pipeline 没有定义</li>
</ol>
<pre><code class="yaml">clone:
    disable: true
</code></pre>
<p>的话，compiler 会在 spec 中注入 <code>clone-step</code>，compiler 会初始化好该步骤信息，如 <code>step name</code>、<code>image</code>、<code>mount workspace</code>。<br>4. 处理完 clone step 后，compiler 会处理 pipeline 中所有的 <code>Services</code>，每个 Service 也会被转换成 step 注入到 spec 中，不过与普通 step 不同的是 service 会被设置为单独运行，换个说法它们不依赖任何 step，同样 compiler 会为每个 service 相关的 step 做好和 clone step 类似的初始化工作。<br>5. 接下来就是处理不同的 steps，处理普通 step 分两种情况，一种是 step 中使用了 build 配置，使用了这种配置 drone 会在执行该 step 的过程中自动为 repo 打包，因为打包过程中需要使用到 docker，所有在处理该 step 时，需要<code>额外</code>将<code>docker.sock</code> 文件挂在到 <code>container</code>，另一种情况则是按正常的流程处理。</p>
<blockquote>
<p>正常的处理流程（包括clone,services 和 steps)：1. 将 yaml 中的数据能复制的都复制到 spec 2. 为 spec 注入 yaml 中配置的 volumes 3. 为 spec 注入 yaml 中配置的 envs 4. 将 yaml 中的 setting 中的配置作为环境变量 “PLUGIN_:&quot;+key: value 注入 spec （有些 env 和 setting 的值可能为 from_secret，这里就为会 spec 注入 secret）5. 将 yaml 中定义的 command 转换为 file，路径为 “&#x2F;usr&#x2F;drone&#x2F;bin&#x2F;init” 并注入 spec（之后运行时只需要运行该脚本即可）</p>
</blockquote>
<ol start="6">
<li>最后 compiler 会执行之前定义好的所有 transform function，为 spec 注入 <code>docker auth</code>、来自 controller 和 <code>DRONE_RUNNER_*</code> 定义的环境变量，网络规则和 <code>SecretService</code> 中获取的 secret 等资源。至此 spec 的所有信息已经生成完毕。</li>
</ol>
<h3 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h3><ol>
<li>接下来 runner 会将 stage 中所有 step 的状态设置为 <code>Pending</code> 并保存到执行列表中，并初始化 <code>runtime.Hook</code>，在 hook 中会定义好执行每个 step 之前之后需要执行哪些步骤。在执行每个 step 之前，会创建一个 <code>streamer</code> 用于接收 log，并在数据库中更新 step 的状态，然后将 repo 的信息通过长连接推送给绑定的客户端。每次 step 执行完之后，会更新数据库中的信息，推送事件，并将之前创建的 <code>streamer</code> 删除。hook 还定义了写入日志函数，这样会将获取到的日志写入日志库。</li>
<li>定义好 hook 后，runner 会将 stage 的状态设置为 <code>Running</code>。在开始 build 之前，runner 会更新 stage 的状态，并将每个 step 保存到数据库，然后更新整个 build 的信息。</li>
</ol>
<h3 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h3><ol>
<li><code>runner</code> 初始化好 <code>runtime</code> 的信息后就会调用 <code>runtime.Run</code> 来执行构建，这一步才是真正开始构建。runtime 先调用先前定义好的 <code>Before</code> 函数创建好 streamer，接着 k8s 会创建出一个随机字符串为 name 的 namespace，接下来所有的 step 都会在该 namespace 完成。创建好 namespace 之后会创建构建所需的 <code>secret</code>，接着会将每个 step 中 <code>command</code> 内的信息创建为一个 <code>configmap</code>。</li>
<li>创建完成后 runtime 会开始执行每个 step，runtime 会判断各个 step 之间是否有依赖关系，如果没有则会按顺序一个一个执行。如果有依赖关系，则先运行没有依赖的 step，每次运行完该 step 后，将该 step 从其他依赖它的 step 的 depend 列表中移除，再进行如上操作，直到所有 step 都被运行（这一过程是并发的）。</li>
<li>每个 step 的执行其实就是在 k8s 中创建一个 pod，该 pod 的 image 就是设置的 yaml 中每个 step 定义的 image，所有的 pod 都会在👆的 namespace 下运行，为了保证每个 pod 都能共享文件，所有的 pod 都需要被调度到同一台机器，并且挂载同一个目录下的 <code>HostPath Volume</code>，而这台机器也就是 <code>drone-job-stage.ID-randomString</code> 被调度到的那台机器。当每个 pod 运行后，runtime 会注册一个回调函数来监听 pod 的变化，如果 pod 的状态变为 <code>running</code> 或者 <code>succeed</code> 或者 <code>failed</code> 之后，runtime 就会去获取该 pod 的日志，并把日志写入 <code>streamer</code> 中。最后 pod 运行结束后，runtime 会收集 pod 的退出状态，以判断是正常退出还是非正常退出。</li>
<li>等到所有的 pod 都执行完毕(或者有 pod 执行失败)，runtime 首先会更新数据库中相关数据的状态，然后会做清理工作，并检查当前 build 内所有的 pipeline，如果有 pipeline 依赖其他 pipeline 并且其他 piepline 已经执行完成，那么就会<code> 调度</code> 该 pipeline。</li>
<li>直到 build 中所有 pipeline 都完成了调度，本次 build 即为结束。</li>
</ol>
<p>
        <span class="lazyload-img-span">
        <img   
           data-src="/images/drone_k8s/controller.png" >
        </sapn>
      </p>

        <!-- 分类文章 -->
        
      </div>
      <div class="post-content-inner-space">
        
          <div class="space-toc-main animate__animated  animate__fadeInUp">
            <ol class="space-toc"><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E7%BB%93%E6%9E%84"><span class="space-toc-text">结构</span></a></li><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="space-toc-text">执行过程</span></a></li></ol>
           </div>
        
      </div>
   </div>
    <!-- 评论 -->
    
  </div>
</article>
  </div>
</div>



<!-- 如果是home模式的话，不在首页就显示footer，如果不是home模式的话 所有都显示footer -->

  <div class="footer-outer animate__animated  animate__fadeInUp">
    <div class="footer-inner">
    <div class="footer-text">
    <p>Power by <a target="_blank" rel="noopener" href="http://hexo.io/">Hexo</a> Theme by <a target="_blank" rel="noopener" href="https://github.com/FuShaoLei/hexo-theme-white">White</a></p>

    </div>
    <div class="footer-contact">
    <ul class="footer-ul">
        
        <li class="footer-li">
            <a href="https://github.com/domechn" target="_blank">
                <i class="ri-github-line"></i>
            </a>
        </li>
        
        <li class="footer-li">
            <a href="mailto:domdoumc@gmail.com" target="_blank">
                <i class="ri-mail-line"></i>
            </a>
        </li>
        
    </ul>
    </div>
    </div>
</div>






<script src="/js/white.js"></script>



    
      
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/highlight.min.js"></script>

      <script>hljs.initHighlightingOnLoad();</script>
    

</body>
</html>
